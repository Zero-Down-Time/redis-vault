---
# ConfigMap for backup configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-vault-config
  namespace: redis
data:
  config.yaml: |
    redis:
      connection_string: "redis://localhost:6379"
      data_path: "/data"
      node_name: "redis-master-0"
      backup_master: true
      backup_replica: false
    backup:
      interval: "1h"
      dump_filename: "dump.rdb"
    storage:
      type: S3
      bucket: "my-redis-vault"
      prefix: "k8s/production"
      region: "us-west-2"
    retention:
      keep_last: 10
      keep_duration: "30d"

---
# Secret for cloud credentials
apiVersion: v1
kind: Secret
metadata:
  name: backup-credentials
  namespace: redis
type: Opaque
stringData:
  # For AWS S3
  AWS_ACCESS_KEY_ID: "your-access-key"
  AWS_SECRET_ACCESS_KEY: "your-secret-key"

  # For GCP (base64 encoded service account JSON)
  # GOOGLE_APPLICATION_CREDENTIALS_JSON: "base64-encoded-json"

---
# StatefulSet for Redis with backup sidecar
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis-master
  namespace: redis
spec:
  serviceName: redis-master
  replicas: 1
  selector:
    matchLabels:
      app: redis
      role: master
  template:
    metadata:
      labels:
        app: redis
        role: master
    spec:
      containers:
      # Main Redis container
      - name: redis
        image: redis:7-alpine
        command:
          - redis-server
          - --save
          - "60"
          - "1"
          - --appendonly
          - "no"
        ports:
        - containerPort: 6379
          name: redis
        volumeMounts:
        - name: redis-data
          mountPath: /data
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          tcpSocket:
            port: 6379
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          exec:
            command:
            - redis-cli
            - ping
          initialDelaySeconds: 5
          periodSeconds: 5

      # Backup sidecar container
      - name: backup-sidecar
        image: your-registry/redis-vault:latest
        args:
          - --config
          - /config/config.yaml
        env:
        - name: RUST_LOG
          value: "info"
        # Environment variables override config file values
        # Uncomment to override specific settings:
        # - name: BACKUP_INTERVAL
        #   value: "30m"
        # - name: S3_BUCKET
        #   value: "override-bucket"
        envFrom:
        - secretRef:
            name: backup-credentials
        volumeMounts:
        - name: redis-data
          mountPath: /data
          readOnly: true
        - name: backup-config
          mountPath: /config
        resources:
          requests:
            memory: "128Mi"
            cpu: "50m"
          limits:
            memory: "256Mi"
            cpu: "200m"

      volumes:
      - name: backup-config
        configMap:
          name: redis-vault-config

  volumeClaimTemplates:
  - metadata:
      name: redis-data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: "standard"
      resources:
        requests:
          storage: 10Gi

---
# Service for Redis
apiVersion: v1
kind: Service
metadata:
  name: redis-master
  namespace: redis
spec:
  selector:
    app: redis
    role: master
  ports:
  - port: 6379
    targetPort: 6379
  clusterIP: None
