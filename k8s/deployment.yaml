---
# ConfigMap for backup configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-vault-config
  namespace: redis
data:
  config.yaml: |
    redis:
      connection_string: "redis://localhost:6379"
      data_path: "/data"
      node_name: "redis-master-0"
      backup_master: true
      backup_replica: false
    backup:
      storage_url: "s3://my-redis-vault/k8s/production"
      interval: "1h"
      dump_filename: "dump.rdb"
      initial_delay: "300s"
    retention:
      keep_last: 10
      keep_duration: "30d"
    logging:
      format: "json"
      level: "info"
    metrics:
      enabled: true
      port: 9090
      listen_address: "0.0.0.0"

---
# Secret for cloud credentials
apiVersion: v1
kind: Secret
metadata:
  name: backup-credentials
  namespace: redis
type: Opaque
stringData:
  # For AWS S3 (used when storage_url starts with s3://)
  AWS_ACCESS_KEY_ID: "your-access-key"
  AWS_SECRET_ACCESS_KEY: "your-secret-key"
  # Optionally set AWS region if not using default
  # AWS_REGION: "us-west-2"

  # For GCP (used when storage_url starts with gs://)
  # GOOGLE_APPLICATION_CREDENTIALS_JSON: "base64-encoded-json"

---
# StatefulSet for Redis with backup sidecar
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis-master
  namespace: redis
spec:
  serviceName: redis-master
  replicas: 1
  selector:
    matchLabels:
      app: redis
      role: master
  template:
    metadata:
      labels:
        app: redis
        role: master
    spec:
      containers:
      # Main Redis container
      - name: redis
        image: redis:7-alpine
        command:
          - redis-server
          - --save
          - "60"
          - "1"
          - --appendonly
          - "no"
        ports:
        - containerPort: 6379
          name: redis
        volumeMounts:
        - name: redis-data
          mountPath: /data
        resources:
          requests:
            memory: "256Mi"
            cpu: "100m"
          limits:
            memory: "1Gi"
            cpu: "500m"
        livenessProbe:
          tcpSocket:
            port: 6379
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          exec:
            command:
            - redis-cli
            - ping
          initialDelaySeconds: 5
          periodSeconds: 5

      # Backup sidecar container
      - name: backup-sidecar
        image: your-registry/redis-vault:latest
        args:
          - --config
          - /config/config.yaml
        ports:
        - containerPort: 9090
          name: metrics
        env:
        - name: RUST_LOG
          value: "info"
        # Environment variables override config file values
        # Uncomment to override specific settings:
        # - name: REDIS_CONNECTION
        #   value: "redis://localhost:6379"
        # - name: REDIS_DATA_PATH
        #   value: "/data"
        # - name: REDIS_NODE_NAME
        #   value: "redis-master-0"
        # - name: BACKUP_MASTER
        #   value: "true"
        # - name: BACKUP_REPLICA
        #   value: "false"
        # - name: STORAGE_URL
        #   value: "s3://my-redis-vault/k8s/production"
        # - name: BACKUP_INTERVAL
        #   value: "1h"
        # - name: DUMP_FILENAME
        #   value: "dump.rdb"
        # - name: INITIAL_DELAY
        #   value: "300s"
        # - name: RETENTION_KEEP_LAST
        #   value: "10"
        # - name: RETENTION_KEEP_DURATION
        #   value: "30d"
        # - name: LOG_FORMAT
        #   value: "json"
        # - name: LOG_LEVEL
        #   value: "info"
        # - name: METRICS_ENABLED
        #   value: "true"
        # - name: METRICS_PORT
        #   value: "9090"
        # - name: METRICS_LISTEN_ADDRESS
        #   value: "0.0.0.0"
        envFrom:
        - secretRef:
            name: backup-credentials
        volumeMounts:
        - name: redis-data
          mountPath: /data
          readOnly: true
        - name: backup-config
          mountPath: /config
        resources:
          requests:
            memory: "128Mi"
            cpu: "50m"
          limits:
            memory: "256Mi"
            cpu: "200m"

      volumes:
      - name: backup-config
        configMap:
          name: redis-vault-config

  volumeClaimTemplates:
  - metadata:
      name: redis-data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: "standard"
      resources:
        requests:
          storage: 10Gi

---
# Service for Redis
apiVersion: v1
kind: Service
metadata:
  name: redis-master
  namespace: redis
spec:
  selector:
    app: redis
    role: master
  ports:
  - port: 6379
    targetPort: 6379
  clusterIP: None
